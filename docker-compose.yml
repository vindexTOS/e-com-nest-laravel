services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - api-gateway
      - admin-service
      - soketi
    networks:
      - ecom-network
    restart: unless-stopped

  # Nest.js API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
      target: production
    expose:
      - "3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${API_GATEWAY_PORT:-3000}
      # Write Database (for writes)
      - DATABASE_WRITE_HOST=${DB_WRITE_HOST:-postgres-write}
      - DATABASE_WRITE_PORT=${DB_PORT:-5432}
      - DATABASE_WRITE_USER=${DB_USER:-ecom_user}
      - DATABASE_WRITE_PASSWORD=${DB_PASSWORD:-ecom_password}
      - DATABASE_WRITE_NAME=${DB_NAME_WRITE:-ecom_db_write}
      # Read Database (for reads)
      - DATABASE_READ_HOST=${DB_READ_HOST:-postgres-read}
      - DATABASE_READ_PORT=${DB_PORT:-5432}
      - DATABASE_READ_USER=${DB_USER:-ecom_user}
      - DATABASE_READ_PASSWORD=${DB_PASSWORD:-ecom_password}
      - DATABASE_READ_NAME=${DB_NAME_READ:-ecom_db_read}
      # Legacy support (defaults to write)
      - DATABASE_HOST=${DB_WRITE_HOST:-postgres-write}
      - DATABASE_PORT=${DB_PORT:-5432}
      - DATABASE_USER=${DB_USER:-ecom_user}
      - DATABASE_PASSWORD=${DB_PASSWORD:-ecom_password}
      - DATABASE_NAME=${DB_NAME_WRITE:-ecom_db_write}
      # Redis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      # Elasticsearch
      - ELASTICSEARCH_NODE=${ELASTICSEARCH_NODE:-http://elasticsearch:9200}
      # JWT
      - JWT_SECRET=${JWT_SECRET:-test-secret-key-for-development-only-change-in-production}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-7d}
      # Email
      - EMAIL_USER=${EMAIL_USER:-g.kutateli@gmail.com}
      - EMAIL_PASS=${EMAIL_PASS:-pkal cqkl xodw rhti}
      # Pusher/Soketi
      - PUSHER_APP_ID=${PUSHER_APP_ID:-ecom-app}
      - PUSHER_APP_KEY=${PUSHER_APP_KEY:-ecom-key}
      - PUSHER_APP_SECRET=${PUSHER_APP_SECRET:-ecom-secret}
      - PUSHER_HOST=${PUSHER_HOST:-soketi}
      - PUSHER_PORT=${PUSHER_PORT:-6001}
      - PUSHER_SCHEME=${PUSHER_SCHEME:-http}
      - PUSHER_APP_CLUSTER=${PUSHER_APP_CLUSTER:-mt1}
      # Webhook
      - LARAVEL_WEBHOOK_URL=${LARAVEL_WEBHOOK_URL:-http://admin-service:8000/api/webhook}
      - TEST_WEB_HOOK_KEY=${TEST_WEB_HOOK_KEY:-test-webhook-key-change-in-production}
    depends_on:
      postgres-write:
        condition: service_healthy
      postgres-read:
        condition: service_healthy
      redis:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    networks:
      - ecom-network
    restart: unless-stopped

  # PostgreSQL Write Database (CQRS: Primary for writes from both services)
  postgres-write:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${DB_USER:-ecom_user}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-ecom_password}
      - POSTGRES_DB=${DB_NAME_WRITE:-ecom_db_write}
    volumes:
      - postgres_write_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ecom_user} -d ${DB_NAME_WRITE:-ecom_db_write}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecom-network
    restart: unless-stopped

  # PostgreSQL Read Database (CQRS: Replica for reads from both services)
  postgres-read:
    image: postgres:15-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=${DB_USER:-ecom_user}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-ecom_password}
      - POSTGRES_DB=${DB_NAME_READ:-ecom_db_read}
    volumes:
      - postgres_read_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ecom_user} -d ${DB_NAME_READ:-ecom_db_read}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecom-network
    restart: unless-stopped
    depends_on:
      postgres-write:
        condition: service_healthy

  # Laravel Admin Service
  admin-service:
    build:
      context: ./admin-service
      dockerfile: Dockerfile
      target: production
      args:
        - NODE_ENV=${NODE_ENV:-production}
    expose:
      - "8000"
    environment:
      # Laravel App
      - APP_NAME=${APP_NAME:-EcomAdmin}
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY=${APP_KEY:-base64:test-key-for-development-only}
      - APP_URL=${APP_URL:-http://localhost}
      # Write Database (for writes)
      - DB_WRITE_CONNECTION=pgsql
      - DB_WRITE_HOST=${DB_WRITE_HOST:-postgres-write}
      - DB_WRITE_PORT=${DB_PORT:-5432}
      - DB_WRITE_DATABASE=${DB_NAME_WRITE:-ecom_db_write}
      - DB_WRITE_USERNAME=${DB_USER:-ecom_user}
      - DB_WRITE_PASSWORD=${DB_PASSWORD:-ecom_password}
      # Read Database (for reads)
      - DB_READ_CONNECTION=pgsql
      - DB_READ_HOST=${DB_READ_HOST:-postgres-read}
      - DB_READ_PORT=${DB_PORT:-5432}
      - DB_READ_DATABASE=${DB_NAME_READ:-ecom_db_read}
      - DB_READ_USERNAME=${DB_USER:-ecom_user}
      - DB_READ_PASSWORD=${DB_PASSWORD:-ecom_password}
      # Legacy support (defaults to write)
      - DB_CONNECTION=pgsql
      - DB_HOST=${DB_WRITE_HOST:-postgres-write}
      - DB_PORT=${DB_PORT:-5432}
      - DB_DATABASE=${DB_NAME_WRITE:-ecom_db_write}
      - DB_USERNAME=${DB_USER:-ecom_user}
      - DB_PASSWORD=${DB_PASSWORD:-ecom_password}
      # Redis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_CLIENT=${REDIS_CLIENT:-phpredis}
      # Cache/Queue/Session
      - CACHE_DRIVER=${CACHE_DRIVER:-file}
      - CACHE_STORE=${CACHE_STORE:-file}
      - QUEUE_CONNECTION=${QUEUE_CONNECTION:-redis}
      - SESSION_DRIVER=${SESSION_DRIVER:-file}
      # JWT
      - JWT_SECRET=${JWT_SECRET:-test-secret-key-for-development-only-change-in-production}
      - JWT_EXPIRATION=1h
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-7d}
      # Internal URLs
      - API_GATEWAY_URL=${API_GATEWAY_URL:-http://api-gateway:3000}
      # Broadcasting (Soketi/Pusher)
      - BROADCAST_DRIVER=pusher
      - PUSHER_APP_ID=ecom-app
      - PUSHER_APP_KEY=ecom-key
      - PUSHER_APP_SECRET=ecom-secret
      - PUSHER_HOST=soketi
      - PUSHER_PORT=6001
      - PUSHER_SCHEME=http
      - PUSHER_APP_CLUSTER=mt1
      # Webhook
      - TEST_WEB_HOOK_KEY=${TEST_WEB_HOOK_KEY:-test-webhook-key-change-in-production}
    volumes:
      - admin_storage:/var/www/html/storage
    depends_on:
      postgres-write:
        condition: service_healthy
      postgres-read:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - ecom-network
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ecom-network
    restart: unless-stopped

  # Soketi (Pusher-compatible WebSocket server for Laravel Echo)
  soketi:
    image: quay.io/soketi/soketi:1.6-16-debian
    ports:
      - "6001:6001"
      - "9601:9601"
    environment:
      - SOKETI_DEBUG=1
      - SOKETI_DEFAULT_APP_ID=ecom-app
      - SOKETI_DEFAULT_APP_KEY=ecom-key
      - SOKETI_DEFAULT_APP_SECRET=ecom-secret
      - SOKETI_DEFAULT_APP_ENABLE_CLIENT_MESSAGES=true
    networks:
      - ecom-network
    restart: unless-stopped

  # Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - ecom-network
    restart: unless-stopped

volumes:
  postgres_write_data:
  postgres_read_data:
  redis_data:
  admin_storage:
  elasticsearch_data:

networks:
  ecom-network:
    driver: bridge
